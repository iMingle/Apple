<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>HTML5 APIs</title>
	<script type="text/javascript" src="../../../scripts/jquery/jquery-1.11.1.js"></script>
</head>
<body>
	<div id="idLocation"></div>
	<div id="idLocationDetail"></div>
    <div>
        <img src="../../../resources/images/beautiful0.jpg" alt="Guess" onclick="smear(this)">
    </div>
    <input type="file" accept="./*" multiple onchange="fileinfo(this.files)">
</body>
</html>

<script type="text/javascript">
/**
 * 通过获取地理位置信息在地图上显示当前位置
 */
function getmap() {
	if (!navigator.geolocation) throw "Geolocation not supported";

	var image = document.createElement("img");
	navigator.geolocation.getCurrentPosition(setMapURL);

	return image;

	function setMapURL(pos) {
		// 从参数对象pos中获取位置信息
		var latitude = pos.coords.latitude;								// 纬度
		var longitude = pos.coords.longitude;							// 经度
		var accuracy = pos.coords.accuracy;								// 精度-米

		var url = "http://maps.google.com/maps/api/staticmap?center=" + latitude + "," + longitude + "&size=640x640&sensor=true";
		// 设置一个大致的缩放级别
		var zoomlevel = 20;

		if (accuracy > 80) zoomlevel -= Math.round(Math.log(accuracy / 50) / Math.LN2);

		url += "&zoom=" + zoomlevel;

		image.src = url;
	}
}

/**
 * 异步的获取我的位置，并在指定的元素中显示出来
 */
function whereami(elt) {
	// Pass this object as the 3rd argument to getCurrentPosition()
    var options = {
        // Set to true to get a higher accuracy reading (from GPS, for example)
        // if available. Note, however that this can affect battery life.
        enableHighAccuracy: false, // Approximate is okay: this is the default

        // Set this property if a cached location is good enough.
        // The default is 0, which forces location to be checked anew.
        maximumAge: 300000,        // A fix from the last 5 minutes is okay

        // How long are you willing to wait to get the location?
        // The default is Infinity and getCurrentPosition() never times out
        timeout: 15000             // Don't take more than 15 seconds
    };

    if (navigator.geolocation) // Request position, if supported
        navigator.geolocation.getCurrentPosition(success, error, options); 
    else 
        elt.innerHTMl = "Geolocation not supported in this browser";

    // This function will be invoked if geolocation fails
    function error(e) {
        // The error object has a numeric code and a text message. Code values:
        // 1: the user did not give permission to share his or her location
        // 2: the browser was unable to determine the position
        // 3: a timeout occurred
        elt.innerHTML = "Geolocation error " + e.code + ": " + e.message;
    }

    // This function will be invoked if geolocation succeeds
    function success(pos) {
        // These are the fields that we always get. Note that the timestamp
        // is in the outer object, not the inner, coords object.
        var msg = "At " +
            new Date(pos.timestamp).toLocaleString() + " you were within " + 
            pos.coords.accuracy + " meters of latitude " +
            pos.coords.latitude + " longitude " + 
            pos.coords.longitude + ".";

        // If our device returns altitude, add that information.
        if (pos.coords.altitude) {
            msg += " You are " + pos.coords.altitude + " ± " +
                pos.coords.altitudeAccuracy + "meters above sea level.";
        }
        
        // if our device returns speed and heading, add that, too.
        if (pos.coords.speed) {
            msg += " You are travelling at " + 
                pos.coords.speed + "m/s on heading " +
                pos.coords.heading + ".";
        }

        elt.innerHTML = msg;  // Display all the position information
    }
}

// Asynchronously replace the contents of the image with a smeared version.
// Use it like this: <img src="testimage.jpg" onclick="smear(this)"/>
function smear(img) {
    // Create an offscreen <canvas> the same size as the image
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;

    // Copy the image into the canvas, then extract its pixels
    var context = canvas.getContext("2d");
    context.drawImage(img, 0, 0);
    var pixels = context.getImageData(0,0,img.width,img.height);

    // Send the pixels to a worker thread
    var worker = new Worker("../../../scripts/TheDefinitiveGuide/SmearWorker.js");      // Create worker
    worker.postMessage(pixels);                     // Copy and send pixels

    // Register a handler to get the worker's response
    worker.onmessage = function(e) {
        var smeared_pixels = e.data;                // Pixels from worker
        context.putImageData(smeared_pixels, 0, 0); // Copy them to the canvas
        img.src = canvas.toDataURL();               // And then to the img
        worker.terminate();                         // Stop the worker thread
        canvas.width = canvas.height = 0;           // Don't keep pixels around
    }
}

// 输出选中的文件列表中相关的信息
function fileinfo(files) {
    for (var i = 0; i < files.length; i++) {
        var file = files[i];
        console.info(file.name, file.size, file.type, file.lastModifiedDate);
    }
}

$(function() {
	$("#idLocation").append(getmap());

	var div = document.createElement(div);
	$("#idLocationDetail").append(div);
	whereami(div);	// At 2015/1/25 下午6:32:39 you were within 32 meters of latitude 40.0750879 longitude 116.4131011.

    var bytes = new Uint8Array(4);
    for (var i = 0; i < bytes.length; i++) {
        bytes[i] = i & 0xFF;
    }

    for (var i = 0; i < bytes.length; i++) {
        console.info(bytes[i]);
    }

    console.info(bytes.buffer);                     // ArrayBuffer {}
    console.info(bytes.byteOffset);                 // 0
    console.info(bytes.length);                     // 4

    var buf = new ArrayBuffer(1024);
    var asbytes = new Uint8Array(buf);
    for (var i = 0; i < asbytes.length; i++) {
        asbytes[i] = i & 0xFF;
    }

    var view = DataView(buf);
    console.info(view.getInt8(2));                  // 2


});
</script>